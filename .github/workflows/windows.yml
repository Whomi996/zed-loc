name: Windows 编译

on:
  schedule:
    - cron: "0 0 * * *" # 每天 UTC 00:00
  workflow_dispatch:
    inputs:
      l10n_json:
        description: "用于替换的本地化 JSON 文件路径（默认 zh.json）"
        required: false
        default: "zh.json"
      create_release:
        description: "是否发布到 GitHub Release（仅 main 分支生效）"
        required: false
        type: boolean
        default: true
  push:
    branches: [main]
    paths:
      - ".github/workflows/windows.yml"
      - "replace.py"
      - "tools/auto_fill_l10n.py"
      - "zh.json"
      - "zh-*/**"
      - "NOTICE.md"
      - "LICENSE"

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        backend: [vulkan, opengl]
        include:
          - backend: vulkan
            artifact_name: zed-release
            rustflags: ""
          - backend: opengl
            artifact_name: zed-release-opengl
            rustflags: "--cfg gles"

    steps:
      - name: Enable long paths in Git
        run: |
          git config --system core.longpaths true

      - name: Enable long paths in Windows
        shell: powershell
        run: |
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
            -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force

      - name: Checkout self
        uses: actions/checkout@v4

      - name: Checkout Zed
        uses: actions/checkout@v4
        with:
          repository: zed-industries/zed
          ref: main
          path: zed

      - name: 设置 Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: 生成增强版本地化 JSON（保守）
        shell: pwsh
        env:
          L10N_JSON: ${{ github.event.inputs.l10n_json || 'zh.json' }}
        run: |
          python3 tools/auto_fill_l10n.py --input "$env:L10N_JSON" --output "l10n.generated.json" --max 250 --require-uppercase-start

      - name: 替换
        shell: pwsh
        env:
          L10N_JSON: ${{ github.event.inputs.l10n_json || 'zh.json' }}
        run: python3 replace.py "l10n.generated.json"

      - name: Install rust nightly
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly
          override: true
          target: wasm32-wasip1

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2.7.3
        with:
          key: ${{ matrix.backend }}
          workspaces: "zed -> target"

      - name: Setup rustflags
        run: pwsh ./Parse-Rustflags.ps1 ${{ matrix.rustflags }}

      - name: Build release
        working-directory: zed
        run: cargo build --release

      - name: Prepare package
        shell: pwsh
        env:
          L10N_JSON: ${{ github.event.inputs.l10n_json || 'zh.json' }}
          REPO: ${{ github.repository }}
        run: |
          $ErrorActionPreference = "Stop"

          $pkg = "package"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null

          Copy-Item "zed/target/release/zed.exe" "$pkg/zed.exe"
          Copy-Item "NOTICE.md" "$pkg/NOTICE.md"
          Copy-Item "LICENSE" "$pkg/LICENSE.zed-loc.MIT.txt"
          Copy-Item "l10n.generated.json" "$pkg/l10n.generated.json" -ErrorAction SilentlyContinue

          New-Item -ItemType Directory -Force -Path "$pkg/licenses" | Out-Null
          Copy-Item "zed/LICENSE*" "$pkg/licenses/" -ErrorAction SilentlyContinue

          $zedSha = (git -C zed rev-parse HEAD).Trim()
          $locSha = (git rev-parse HEAD).Trim()
          $backend = "${{ matrix.backend }}"
          $inputJson = "$env:L10N_JSON"
          $usedJson = "l10n.generated.json"

          $buildInfo = @(
            "Zed commit: $zedSha",
            "zed-loc commit: $locSha",
            "Backend: $backend",
            "Input L10N JSON: $inputJson",
            "Used L10N JSON: $usedJson"
          ) -join "`n"
          $buildInfo | Out-File -Encoding UTF8 "$pkg/BUILD_INFO.txt"

          $sourceInfo = @(
            "对应源码 / Source:",
            "- Zed: https://github.com/zed-industries/zed @ $zedSha",
            "- zed-loc(本仓库): https://github.com/$env:REPO @ $locSha",
            "",
            "复现构建 / Reproduce:",
            "- checkout Zed 到 ./zed（commit $zedSha）",
            "- 运行：python3 tools/auto_fill_l10n.py --input $inputJson --output $usedJson --max 250 --require-uppercase-start",
            "- 运行：python3 replace.py $usedJson",
            "- 在 ./zed 下：cargo build --release",
            "",
            "许可证 / Licenses:",
            "- 本仓库：MIT（见 LICENSE.zed-loc.MIT.txt）",
            "- Zed：见 licenses/ 目录（从上游源码复制的 LICENSE*）"
          ) -join "`n"
          $sourceInfo | Out-File -Encoding UTF8 "$pkg/SOURCE.txt"

      - name: Archive build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: package

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true') || (github.event_name == 'push' && contains(github.event.head_commit.message, '[release]')))
    permissions:
      contents: write

    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Set release tag
        run: |
          echo "RELEASE_TAG=$(date +'%Y%m%d')-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          echo "RELEASE_NAME=$(date +'%Y%m%d') #${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Create release zips
        run: |
          mkdir -p zed-release zed-release-opengl
          cp -a artifacts/zed-release/. zed-release/
          cp -a artifacts/zed-release-opengl/. zed-release-opengl/
          (cd zed-release && zip -r ../zed-windows.zip .)
          (cd zed-release-opengl && zip -r ../zed-windows-opengl.zip .)

      - name: Upload release build artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.RELEASE_TAG }}
          draft: false
          make_latest: true
          files: |
            zed-windows.zip
            zed-windows-opengl.zip
